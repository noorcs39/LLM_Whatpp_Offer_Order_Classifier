<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Send Offer - Bag Offer App</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
    function toggleMenu() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    }
  </script>
</head>
<body class="bg-blue-900 text-white">
  <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 shadow-2xl sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
              <span class="text-2xl">üëú</span>
            </div>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white tracking-tight">BagOffer</h1>
            <p class="text-blue-200 text-xs">Premium Bags Marketplace</p>
          </div>
        </div>
        
        <!-- Desktop Menu -->
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-1">
            <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Home</a>
            <a href="match.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Match</a>
            <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Orders</a>
            <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Offers</a>
            <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Search</a>
            <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Customers</a>
            <a href="send.html" class="text-white bg-blue-700 bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Send</a>
            <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 px-3 py-2 rounded-md text-sm font-bold transition-all duration-200 shadow-sm">WhatsApp</a>
            <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">About</a>
          </div>
        </div>
        
        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button type="button" class="bg-blue-800 inline-flex items-center justify-center p-2 rounded-md text-blue-200 hover:text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-800 focus:ring-white" onclick="toggleMenu()">
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu -->
    <div class="md:hidden hidden" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-blue-800 bg-opacity-95 backdrop-blur-sm">
        <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Home</a>
        <a href="match.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Match</a>
        <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Orders</a>
        <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Offers</a>
        <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Search</a>
        <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Customers</a>
        <a href="send.html" class="text-white bg-blue-700 bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Send</a>
        <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 block px-3 py-2 rounded-md text-base font-bold">WhatsApp</a>
        <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">About</a>
      </div>
    </div>
  </nav>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
      <!-- Header Section -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Send Offers & Messages</h1>
        <p class="text-lg text-gray-600">Send personalized offers and messages to your customers</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-blue-100 text-sm font-medium">Total Customers</p>
              <p class="text-3xl font-bold" id="totalCustomers">0</p>
            </div>
            <div class="bg-blue-400 bg-opacity-20 p-3 rounded-full">
              <span class="text-2xl">üë•</span>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-purple-100 text-sm font-medium">Active Messages</p>
              <p class="text-3xl font-bold" id="totalMessages">0</p>
            </div>
            <div class="bg-purple-400 bg-opacity-20 p-3 rounded-full">
              <span class="text-2xl">üí¨</span>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-emerald-100 text-sm font-medium">Last Updated</p>
              <p class="text-3xl font-bold" id="lastUpdated">Now</p>
            </div>
            <div class="bg-emerald-400 bg-opacity-20 p-3 rounded-full">
              <span class="text-2xl">üîÑ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Form -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
          <span class="mr-2">üì±</span>
          Compose Message
        </h2>
        
        <form onsubmit="return sendMessage(event)" class="space-y-6">
          <!-- Customer Selection -->
          <div>
            <label class="block text-lg font-semibold text-gray-700 mb-2">Select Customer</label>
            <div class="relative">
              <select id="number" class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg text-gray-900 focus:border-blue-500 focus:outline-none transition-colors appearance-none bg-white pr-10" onchange="loadPreviousMessages()">
                <option value="" class="text-gray-500">Choose a customer...</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Previous Messages -->
          <div>
            <label class="block text-lg font-semibold text-gray-700 mb-2">Reply to Previous Message (Optional)</label>
            <div id="previousMessages" class="border-2 border-gray-200 rounded-xl max-h-64 overflow-y-auto p-4 text-base space-y-3 bg-gray-50"></div>
          </div>

          <!-- Message -->
          <div>
            <label class="block text-lg font-semibold text-gray-700 mb-2">Message</label>
            <textarea id="message" class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg text-gray-900 focus:border-blue-500 focus:outline-none transition-colors" rows="4" placeholder="Type your message here..."></textarea>
          </div>

          <!-- Image Upload -->
          <div>
            <label class="block text-lg font-semibold text-gray-700 mb-2">Upload Image</label>
            <input type="file" id="image" class="w-full text-lg p-2 border-2 border-gray-200 rounded-xl" accept="image/*" />
          </div>

          <!-- Buttons -->
          <div class="flex items-center space-x-4">
            <button type="submit" class="bg-blue-800 text-white px-8 py-3 rounded-xl hover:bg-blue-700 text-lg font-semibold transition-colors shadow-lg">
              Send Message
            </button>
            <button type="button" onclick="resetForm()" class="bg-gray-400 text-white px-8 py-3 rounded-xl hover:bg-gray-500 text-lg font-semibold transition-colors">
              Reset Form
            </button>
          </div>
        </form>

        <!-- Status Messages -->
        <div id="status" class="hidden mt-6 p-4 rounded-xl text-center text-lg font-semibold"></div>
      </div>
    </div>
  </main>

  <style>
    /* Ensure dropdown options are visible */
    select option {
      color: #111827;
      background-color: #ffffff;
    }
    
    select option:hover,
    select option:focus {
      background-color: #f3f4f6;
    }
    
    /* Loading spinner */
    .loading-spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
  <script>
    let selectedReplies = [];

    function getLanguageLabel(code) {
      const map = {
        'en': 'üá¨üáß English', 'de': 'üá©üá™ German', 'fr': 'üá´üá∑ French', 'es': 'üá™üá∏ Spanish',
        'pt': 'üáµüáπ Portuguese', 'ru': 'üá∑üá∫ Russian', 'it': 'üáÆüáπ Italian', 'tr': 'üáπüá∑ Turkish',
        'ar': 'üá∏üá¶ Arabic', 'zh': 'üá®üá≥ Chinese', 'ja': 'üáØüáµ Japanese'
      };
      return map[code] || code.toUpperCase();
    }

    async function sendMessage(event) {
      event.preventDefault();
      
      const number = document.getElementById('number').value;
      const message = document.getElementById('message').value;
      const image = document.getElementById('image').files[0];
      const status = document.getElementById('status');
      
      if (!number) {
        showStatus('Please select a customer first', 'error');
        return;
      }
      
      if (!message.trim()) {
        showStatus('Please enter a message', 'error');
        return;
      }

      const context = selectedReplies.map(msg => msg).join('\n---\n');
      const fullMessage = context ? `‚è∞ Referring to:\n"${context}"\n---\nHere is Details:\n${message}` : message;

      // Show loading state
      showStatus('Sending message...', 'loading');

      let imageBase64 = '';
      if (image) {
        const reader = new FileReader();
        reader.onload = async function () {
          imageBase64 = reader.result.split(',')[1];
          await sendPayload();
        };
        reader.readAsDataURL(image);
      } else {
        await sendPayload();
      }

      async function sendPayload() {
        try {
          console.log('Sending message to:', number);
          console.log('Message:', fullMessage);
          
          const res = await fetch('/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to: number, text: fullMessage, imageBase64 })
          });
          
          if (res.ok) {
            showStatus(`‚úÖ Message sent successfully to ${number}`, 'success');
            // Reset form after successful send
            setTimeout(() => {
              resetForm();
              loadNumbers(); // Refresh customer list
            }, 2000);
          } else {
            const error = await res.text();
            console.error('Send message error:', error);
            showStatus(`‚ùå Failed to send message: ${error}`, 'error');
          }
        } catch (error) {
          console.error('Network error:', error);
          showStatus(`‚ùå Network error: ${error.message}`, 'error');
        }
      }
    }

    function showStatus(text, type) {
      const status = document.getElementById('status');
      status.className = `mt-6 p-4 rounded-xl text-center text-lg font-semibold ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' :
        type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
        type === 'loading' ? 'bg-blue-100 text-blue-800 border border-blue-300' :
        'bg-gray-100 text-gray-800 border border-gray-300'
      }`;
      status.textContent = text;
      status.classList.remove('hidden');
    }

    function resetForm() {
      document.getElementById('number').value = '';
      document.getElementById('message').value = '';
      document.getElementById('image').value = '';
      document.getElementById('status').classList.add('hidden');
      document.getElementById('status').textContent = '';
      selectedReplies = [];
      document.getElementById('previousMessages').innerHTML = '';
    }

    async function fetchMessages() {
      try {
        const res = await fetch('/messages');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        console.log('Fetched messages:', data.length, 'messages');
        return Array.isArray(data) ? data : [];
      } catch (error) {
        console.error('Error fetching messages:', error);
        return [];
      }
    }

    function updateStats(messages) {
      const uniqueNumbers = new Set(messages.map(msg => msg.number));
      const totalCustomers = document.getElementById('totalCustomers');
      const totalMessages = document.getElementById('totalMessages');
      const lastUpdated = document.getElementById('lastUpdated');
      
      if (totalCustomers) totalCustomers.textContent = uniqueNumbers.size;
      if (totalMessages) totalMessages.textContent = messages.length;
      if (lastUpdated) lastUpdated.textContent = new Date().toLocaleTimeString();
    }

    async function loadNumbers() {
      const select = document.getElementById('number');
      if (!select) return;
      
      // Show loading state
      select.innerHTML = '<option value="" class="text-blue-500">üì± Loading customers...</option>';
      
      try {
        console.log('Loading customer numbers...');
        const messages = await fetchMessages();
        console.log('Found', messages.length, 'messages');
        updateStats(messages);

        const uniqueNumbers = {};
        messages.forEach(msg => {
          if (msg.number && !uniqueNumbers[msg.number]) {
            uniqueNumbers[msg.number] = msg.name || "No Name";
          }
        });
        
        select.innerHTML = '<option value="" class="text-gray-500">Choose a customer...</option>';
        
        if (Object.keys(uniqueNumbers).length === 0) {
          const option = document.createElement('option');
          option.value = "";
          option.textContent = "üìµ No customers found - Connect WhatsApp to start receiving messages";
          option.disabled = true;
          option.style.color = '#ef4444';
          select.appendChild(option);
          return;
        }

        // Sort numbers for better UX
        const sortedNumbers = Object.keys(uniqueNumbers).sort();
        
        for (const number of sortedNumbers) {
          const option = document.createElement('option');
          option.value = number;
          option.textContent = `üìû ${number} (${uniqueNumbers[number]})`;
          option.style.color = '#111827';
          select.appendChild(option);
        }
        
        console.log('Loaded', sortedNumbers.length, 'customers');
      } catch (error) {
        console.error('Error loading numbers:', error);
        select.innerHTML = '<option value="" class="text-red-500">‚ùå Error loading customers</option>';
      }
    }

    async function loadPreviousMessages() {
      const container = document.getElementById('previousMessages');
      if (!container) return;
      
      container.innerHTML = '';
      selectedReplies = [];
      
      const selectedNumber = document.getElementById('number')?.value;
      if (!selectedNumber) {
        container.innerHTML = '<p class="text-gray-500 text-center">Select a customer to view previous messages</p>';
        return;
      }

      try {
        const messages = await fetchMessages();
        const customerMessages = messages.filter(m => 
          (m.category === 'order' || m.category === 'offer') && m.number === selectedNumber
        );

        if (customerMessages.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center">No previous orders or offers found for this customer</p>';
          return;
        }

        customerMessages.forEach(msg => {
          const tag = msg.category === 'order' 
            ? `<span class='bg-yellow-400 text-black font-bold px-2 py-1 text-sm rounded'>ORDER</span>` 
            : `<span class='bg-green-400 text-black font-bold px-2 py-1 text-sm rounded'>OFFER</span>`;
          
          const fullText = `${msg.category.toUpperCase()}\nMessage: ${msg.translated || msg.message}\nLanguage: ${getLanguageLabel(msg.language || "en")}\nPrice: Rs. ${msg.price || "N/A"}\nDate: ${new Date(msg.date || msg.timestamp || Date.now()).toLocaleString()}`;
          
          const div = document.createElement('div');
          div.innerHTML = `
            <label class="flex items-start space-x-3 bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-black hover:shadow-md transition-shadow">
              <input type="checkbox" value="${fullText}" class="mt-1 h-4 w-4 text-blue-600 rounded" onchange="toggleReply(this)">
              <div class="flex-1">
                <div class="font-bold text-sm mb-1">From: ${msg.number} (${msg.name || "No Name"}) ${tag}</div>
                <div class="text-sm whitespace-pre-wrap text-gray-700">${fullText.replace(/\n/g, '<br>')}</div>
              </div>
            </label>`;
          container.appendChild(div);
        });
      } catch (error) {
        container.innerHTML = '<p class="text-red-500 text-center">Error loading previous messages</p>';
        console.error('Error loading previous messages:', error);
      }
    }

    function toggleReply(checkbox) {
      const value = checkbox.value;
      if (checkbox.checked) {
        selectedReplies.push(value);
      } else {
        selectedReplies = selectedReplies.filter(v => v !== value);
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      loadNumbers();
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadNumbers();
    }, 30000);
  </script>
<script src="swipe.js"></script>
</body>
</html>
