<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Manager</title>
  
  <!-- PWA support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e40af" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/images/icon-192.png" />

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <script>
    function toggleMenu() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    }
  </script>
</head>
<body class="bg-blue-900 text-white">
  <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 shadow-2xl sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
              <span class="text-2xl">üëú</span>
            </div>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white tracking-tight">BagOffer</h1>
            <p class="text-blue-200 text-xs">Premium Bags Marketplace</p>
          </div>
        </div>
        
        <!-- Desktop Menu -->
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-1">
            <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Home</a>
            <a href="match.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Match</a>
            <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Orders</a>
            <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Offers</a>
            <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Search</a>
            <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Customers</a>
            <a href="send.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Send</a>
            <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 px-3 py-2 rounded-md text-sm font-bold transition-all duration-200 shadow-sm">WhatsApp</a>
            <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">About</a>
          </div>
        </div>
        
        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button type="button" class="bg-blue-800 inline-flex items-center justify-center p-2 rounded-md text-blue-200 hover:text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-800 focus:ring-white" onclick="toggleMenu()">
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu -->
    <div class="md:hidden hidden" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-blue-800 bg-opacity-95 backdrop-blur-sm">
        <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Home</a>
        <a href="match.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Match</a>
        <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Orders</a>
        <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Offers</a>
        <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Search</a>
        <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Customers</a>
        <a href="send.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Send</a>
        <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 block px-3 py-2 rounded-md text-base font-bold">WhatsApp</a>
        <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">About</a>
      </div>
    </div>
  </nav>

  <main class="p-4 md:p-6 space-y-4 md:space-y-6">
    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white text-black p-4 rounded-lg shadow">
        <div class="text-2xl font-bold text-blue-600" id="total-numbers">0</div>
        <div class="text-sm text-gray-600">Total Numbers</div>
      </div>
      <div class="bg-white text-black p-4 rounded-lg shadow">
        <div class="text-2xl font-bold text-green-600" id="active-numbers">0</div>
        <div class="text-sm text-gray-600">Active Connections</div>
      </div>
      <div class="bg-white text-black p-4 rounded-lg shadow">
        <div class="text-2xl font-bold text-purple-600" id="last-updated">Now</div>
        <div class="text-sm text-gray-600">Last Updated</div>
      </div>
    </div>



    <!-- Add New Number Section -->
    <div class="bg-white text-black p-4 md:p-6 rounded-lg shadow">
      <h2 class="text-xl md:text-2xl font-bold mb-4 text-blue-800">‚ûï Add New WhatsApp Number</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Number Name (Optional)</label>
          <input type="text" id="new-number-name" placeholder="e.g., Business Account" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
        </div>
        
        <button onclick="generateQRCode()" id="generate-qr-btn"
                class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 md:px-6 md:py-3 rounded-md hover:bg-blue-700 transition duration-200 font-medium text-sm md:text-base disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          üì≤ Generate QR Code to Connect
        </button>
        <div id="single-connection-warning" class="hidden text-sm text-orange-600 mt-2">
          ‚ö†Ô∏è Only one WhatsApp connection allowed at a time. Please disconnect the current number first.
        </div>

        <div id="qr-container" class="hidden mt-4">
          <div class="bg-gray-100 p-4 rounded-lg text-center">
            <h3 class="font-semibold mb-2 text-lg">üì± Scan QR Code with WhatsApp</h3>
            <div id="qr-code" class="flex justify-center mb-3"></div>
            <p class="text-sm text-gray-600">Open WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a Device</p>
            <div class="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-800">
              üí° Tip: Keep this page open until connected
            </div>
          </div>
        </div>

        <div id="connection-status" class="hidden">
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
            ‚úÖ Successfully connected! The new number is now active.
          </div>
        </div>
      </div>
    </div>

    <!-- Active Sessions Section -->
    <div class="bg-white text-black p-4 md:p-6 rounded-lg shadow">
      <h2 class="text-xl md:text-2xl font-bold mb-4 text-blue-800">‚ö° Active Sessions</h2>
      
      <!-- Mobile-friendly cards for sessions -->
      <div id="sessions-mobile" class="md:hidden space-y-3">
        <!-- Mobile session cards will be populated here -->
      </div>
      
      <!-- Desktop table for sessions -->
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Connected</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="sessions-table" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    let currentQRSession = null;

    async function loadConnectedNumbers() {
      try {
        const response = await fetch('/whatsapp-numbers');
        const numbers = await response.json();
        
        // Update stats
        document.getElementById('total-numbers').textContent = numbers.length;
        document.getElementById('active-numbers').textContent = numbers.filter(n => n.isRealTimeConnected === true).length;
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        
        // Single connection logic - check real-time connection status
        const hasActiveConnection = numbers.filter(n => n.isRealTimeConnected === true).length > 0;
        const generateBtn = document.getElementById('generate-qr-btn');
        const warningDiv = document.getElementById('single-connection-warning');
        
        if (hasActiveConnection) {
          generateBtn.disabled = true;
          warningDiv.classList.remove('hidden');
        } else {
          generateBtn.disabled = false;
          warningDiv.classList.add('hidden');
        }



        // Desktop Table
        const tableBody = document.getElementById('sessions-table');
        tableBody.innerHTML = numbers.map(num => {
          const isConnected = num.isRealTimeConnected === true;
          const statusColor = isConnected ? 'bg-green-400' : 'bg-red-400';
          const statusBg = isConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          const statusText = isConnected ? 'Connected' : 'Disconnected';
          
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                <div class="flex items-center">
                  <div class="w-2 h-2 ${statusColor} rounded-full mr-2"></div>
                  ${num.number}
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                ${num.name || '-'}
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusBg}">
                  ${statusText}
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                <button onclick="disconnectNumber('${num.number}')" 
                        class="text-red-600 hover:text-red-900 transition duration-200 font-medium"
                        ${!isConnected ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                  ${isConnected ? 'Disconnect' : 'Disconnected'}
                </button>
              </td>
            </tr>
          `;
        }).join('');

        // Mobile Cards
        const mobileContainer = document.getElementById('sessions-mobile');
        mobileContainer.innerHTML = numbers.map(num => {
          const isConnected = num.isRealTimeConnected === true;
          const statusBg = isConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          const statusText = isConnected ? '‚óè Active' : '‚óè Disconnected';
          const buttonClass = isConnected ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-400 cursor-not-allowed';
          const buttonText = isConnected ? 'Disconnect Number' : 'Disconnected';
          
          return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-bold text-gray-900 text-lg">${num.number}</div>
                  <div class="text-sm text-gray-600">${num.name || 'No name'}</div>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusBg}">
                  ${statusText}
                </span>
              </div>
              <div class="text-xs text-gray-400 mb-3">
                Connected: ${new Date(num.connectedAt).toLocaleString()}
              </div>
              <button onclick="disconnectNumber('${num.number}')" 
                      class="w-full ${buttonClass} text-white py-2 rounded text-sm transition duration-200"
                      ${!isConnected ? 'disabled' : ''}>
                ${buttonText}
              </button>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading numbers:', error);
        console.error('Error loading numbers:', error);
      }
    }

    async function generateQRCode() {
      const name = document.getElementById('new-number-name').value;
      
      try {
        const response = await fetch('/whatsapp-connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        
        const data = await response.json();
        if (data.qr) {
          document.getElementById('qr-container').classList.remove('hidden');
          document.getElementById('qr-code').innerHTML = `
            <div class="bg-white p-4 inline-block rounded">
              <img src="data:image/png;base64,${data.qr}" alt="QR Code" class="w-64 h-64">
            </div>
          `;
          currentQRSession = data.sessionId;
          
          // Poll for connection status
          pollConnectionStatus();
        }
      } catch (error) {
        console.error('Error generating QR:', error);
        alert('Error generating QR code. Please try again.');
      }
    }

    async function pollConnectionStatus() {
      const checkConnection = async () => {
        try {
          const response = await fetch(`/whatsapp-status/${currentQRSession}`);
          const data = await response.json();
          
          if (data.connected) {
            document.getElementById('connection-status').classList.remove('hidden');
            document.getElementById('qr-container').classList.add('hidden');
            setTimeout(() => {
              loadConnectedNumbers();
              document.getElementById('connection-status').classList.add('hidden');
            }, 3000);
            return;
          }
          
          if (!data.error) {
            setTimeout(checkConnection, 2000);
          }
        } catch (error) {
          console.error('Error checking status:', error);
        }
      };
      
      checkConnection();
    }

    async function disconnectNumber(number) {
      if (confirm(`Are you sure you want to disconnect ${number}?`)) {
        try {
          const response = await fetch('/whatsapp-disconnect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ number })
          });
          
          if (response.ok) {
            // Reload to update button state
            setTimeout(() => {
              loadConnectedNumbers();
            }, 1000);
          }
          
          const data = await response.json();
          if (!response.ok) {
            alert(`Error: ${data.error || 'Failed to disconnect'}`);
            return;
          }
          
          if (data.success) {
            alert(`Successfully disconnected ${number}`);
            loadConnectedNumbers();
          }
        } catch (error) {
          console.error('Error disconnecting:', error);
          alert('Error disconnecting. Please try again.');
        }
      }
    }

    // Load numbers on page load
    loadConnectedNumbers();
  </script>
  
  <!-- Swipe navigation -->
  <script src="swipe.js"></script>
</body>
</html>