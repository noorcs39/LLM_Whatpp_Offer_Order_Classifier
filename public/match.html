<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Match Results - BagOffer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function toggleMenu() {
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenu.classList.toggle('hidden');
    }

    function navigateTo(url) {
      if (url && url !== 'undefined' && url !== 'null') {
        window.open(url, '_blank');
      }
    }

    const languageMap = {
      'en': 'English',
      'hi': 'Hindi',
      'mr': 'Marathi',
      'gu': 'Gujarati',
      'ta': 'Tamil',
      'te': 'Telugu',
      'kn': 'Kannada',
      'ml': 'Malayalam',
      'bn': 'Bengali',
      'pa': 'Punjabi',
      'ur': 'Urdu',
      'or': 'Odia',
      'as': 'Assamese',
      'sa': 'Sanskrit'
    };

    async function loadMatches() {
      try {
        const response = await fetch('/match_results.json');
        const data = await response.json();
        console.log('Loaded data:', data);
        
        let orders = data;
        // Handle the nested structure with order and matches
        if (data && Array.isArray(data)) {
          orders = data;
        } else {
          console.log('Invalid data structure:', data);
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
          return;
        }
        
        if (!orders || orders.length === 0) {
          console.log('No orders found:', orders);
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
          return;
        }

        let totalMatches = 0;
        let totalSimilarity = 0;
        const languages = new Set();

        // Process orders and their matches
        orders.forEach(orderGroup => {
          const matches = orderGroup.matches || [];
          totalMatches += matches.length;
          
          matches.forEach(match => {
            totalSimilarity += match.score || 0;
            languages.add(match.offer?.language || 'en');
          });
        });

        // Update stats
        const totalMatchesEl = document.getElementById('totalMatches');
        const avgSimilarityEl = document.getElementById('avgSimilarity');
        const totalLanguagesEl = document.getElementById('totalLanguages');
        
        if (totalMatchesEl) totalMatchesEl.textContent = totalMatches;
        const avgSimilarity = totalMatches > 0 ? (totalSimilarity / totalMatches) : 0;
        if (avgSimilarityEl) avgSimilarityEl.textContent = Math.round(avgSimilarity) + '%';
        if (totalLanguagesEl) totalLanguagesEl.textContent = languages.size;

        // Generate HTML for orders with their matched offers
        const matchesHTML = orders.map(orderGroup => {
          const order = orderGroup.order || {};
          const orderLang = languageMap[order.language || 'en'] || order.language || 'Unknown';
          const matches = orderGroup.matches || [];
          
          const offersHTML = matches.map(match => {
            const offer = match.offer || {};
            const offerTime = new Date(offer.timestamp || Date.now()).toLocaleString();
            const offerName = offer.name ? `<span class="text-xs sm:text-sm text-gray-600 ml-1 sm:ml-2">by ${offer.name}</span>` : '';
            const score = Math.round(match.score || 0);

            return `
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 sm:p-4 mb-3">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-2">
                  <div class="flex items-center flex-wrap">
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full mr-2 mb-1">OFFER</span>
                    <span class="font-medium text-gray-900 text-sm sm:text-base">${offer.number || 'Unknown'}</span>
                    ${offerName}
                  </div>
                  <div class="text-xs text-gray-500 flex-shrink-0">
                    <span class="flex items-center">
                      <span class="mr-1">🕒</span>
                      ${offerTime}
                    </span>
                  </div>
                </div>

                <p class="text-sm text-gray-700 mb-2 leading-relaxed break-words">${offer.translated || offer.message || 'No message available'}</p>

                <div class="flex flex-wrap gap-1 sm:gap-2">
                  <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">${languageMap[offer.language || 'en'] || offer.language || 'Unknown'}</span>
                  <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">Rs. ${offer.price || 'N/A'}</span>
                  <button onclick="navigateTo('${offer.link || ''}')" class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded-full hover:bg-purple-200 transition-colors">
                    View Offer →
                  </button>
                </div>

                <div class="mt-2 pt-2 border-t border-gray-200">
                  <span class="text-xs font-semibold text-gray-700 flex items-center">
                    <span class="mr-1">🎯</span>
                    Match Score: ${score}%
                  </span>
                </div>
              </div>
            `;
          }).join('');

          return `
            <div class="bg-white border border-gray-200 rounded-xl p-3 sm:p-4 md:p-6 shadow-lg hover:shadow-xl transition-all duration-300">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 sm:mb-4 gap-2">
                <div class="flex items-center flex-wrap">
                  <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full mr-2 mb-1">ORDER</span>
                  <span class="font-bold text-gray-900 text-sm sm:text-base md:text-lg">${order.number || 'Unknown'}</span>
                </div>
                <div class="text-xs sm:text-sm text-gray-500 flex-shrink-0">
                  <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded-full">
                    ${matches.length} match${matches.length !== 1 ? 'es' : ''}
                  </span>
                </div>
              </div>

              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-2">
                  <div class="flex items-center flex-wrap">
                    <span class="font-semibold text-gray-900 text-sm sm:text-base">Order Details</span>
                  </div>
                  <div class="text-xs text-gray-500 flex-shrink-0">
                    <span class="flex items-center">
                      <span class="mr-1">🕒</span>
                      ${new Date(order.timestamp || Date.now()).toLocaleString()}
                    </span>
                  </div>
                </div>

                <p class="text-sm text-gray-700 mb-2 leading-relaxed break-words">${order.translated || order.message || 'No message available'}</p>

                <div class="flex flex-wrap gap-1 sm:gap-2">
                  <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">${orderLang}</span>
                  <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">Rs. ${order.price || 'N/A'}</span>
                  ${order.name ? `<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded-full">${order.name}</span>` : ''}
                </div>
              </div>

              <div class="border-t border-gray-200 pt-3 sm:pt-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Matched Offers:</h4>
                <div class="space-y-3">
                  ${offersHTML}
                </div>
              </div>
            </div>
          `;
        }).join('');

        const matchesEl = document.getElementById('matches');
        const loadingStateEl = document.getElementById('loadingState');
        const emptyStateEl = document.getElementById('emptyState');
        
        if (matchesEl) matchesEl.innerHTML = matchesHTML;
        if (loadingStateEl) loadingStateEl.classList.add('hidden');
        if (emptyStateEl) emptyStateEl.classList.add('hidden');

      } catch (error) {
        console.error('Error loading matches:', error);
        console.error('Error stack:', error.stack);
        
        const loadingStateEl = document.getElementById('loadingState');
        const emptyStateEl = document.getElementById('emptyState');
        const matchesEl = document.getElementById('matches');
        
        if (loadingStateEl) loadingStateEl.classList.add('hidden');
        if (emptyStateEl) emptyStateEl.classList.remove('hidden');
      }
    }

    loadMatches();
    setInterval(loadMatches, 3000);
  </script>
</head>
<body class="bg-blue-900 text-white">
  <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 shadow-2xl sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
              <span class="text-2xl">👜</span>
            </div>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white tracking-tight">BagOffer</h1>
            <p class="text-blue-200 text-xs">Premium Bags Marketplace</p>
          </div>
        </div>
        
        <!-- Desktop Menu -->
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-1">
            <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Home</a>
            <a href="match.html" class="text-white bg-blue-700 bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Match</a>
            <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Orders</a>
            <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Offers</a>
            <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Search</a>
            <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Customers</a>
            <a href="send.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">Send</a>
            <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 px-3 py-2 rounded-md text-sm font-bold transition-all duration-200 shadow-sm">WhatsApp</a>
            <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200">About</a>
          </div>
        </div>
        
        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button type="button" class="bg-blue-800 inline-flex items-center justify-center p-2 rounded-md text-blue-200 hover:text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-800 focus:ring-white" onclick="toggleMenu()">
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu -->
    <div class="md:hidden hidden" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-blue-800 bg-opacity-95 backdrop-blur-sm">
        <a href="index.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Home</a>
        <a href="match.html" class="text-white bg-blue-700 bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Match</a>
        <a href="orders.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Orders</a>
        <a href="offers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Offers</a>
        <a href="search.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Search</a>
        <a href="customers.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Customers</a>
        <a href="send.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">Send</a>
        <a href="whatsapp-manager.html" class="bg-yellow-500 text-blue-900 hover:bg-yellow-400 block px-3 py-2 rounded-md text-base font-bold">WhatsApp</a>
        <a href="about.html" class="text-blue-200 hover:bg-blue-700 hover:bg-opacity-75 block px-3 py-2 rounded-md text-base font-medium">About</a>
      </div>
    </div>
  </nav>

  <main class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-indigo-50 py-4 sm:py-6 md:py-8 px-2 sm:px-4">
    <div class="max-w-7xl mx-auto px-1 sm:px-2">
      <!-- Header Section -->
      <div class="text-center mb-4 sm:mb-6 md:mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl mb-2 sm:mb-4 shadow-lg animate-pulse">
          <span class="text-2xl sm:text-4xl">🔗</span>
        </div>
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-1 sm:mb-2">AI Match Results</h1>
        <p class="text-sm sm:text-base md:text-lg text-gray-600 px-2">Intelligent pairing of orders with relevant offers using machine learning</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 mb-4 sm:mb-6 md:mb-8">
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6 border-l-4 border-purple-500">
          <div class="flex items-center">
            <div class="bg-purple-100 rounded-lg p-2 sm:p-3 mr-2 sm:mr-3 md:mr-4">
              <span class="text-lg sm:text-xl md:text-2xl">📊</span>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs sm:text-sm text-gray-600 truncate">Total Matches</p>
              <p class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900" id="totalMatches">0</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6 border-l-4 border-pink-500">
          <div class="flex items-center">
            <div class="bg-pink-100 rounded-lg p-2 sm:p-3 mr-2 sm:mr-3 md:mr-4">
              <span class="text-lg sm:text-xl md:text-2xl">🎯</span>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs sm:text-sm text-gray-600 truncate">Avg Similarity</p>
              <p class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900" id="avgSimilarity">0%</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6 border-l-4 border-indigo-500">
          <div class="flex items-center">
            <div class="bg-indigo-100 rounded-lg p-2 sm:p-3 mr-2 sm:mr-3 md:mr-4">
              <span class="text-lg sm:text-xl md:text-2xl">🌍</span>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs sm:text-sm text-gray-600 truncate">Languages</p>
              <p class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900" id="totalLanguages">0</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6 border-l-4 border-green-500">
          <div class="flex items-center">
            <div class="bg-green-100 rounded-lg p-2 sm:p-3 mr-2 sm:mr-3 md:mr-4">
              <span class="text-lg sm:text-xl md:text-2xl">⚡</span>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs sm:text-sm text-gray-600 truncate">Live Updates</p>
              <p class="text-xs sm:text-sm text-green-600 font-medium">Every 3s</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Matches Container -->
      <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden">
        <div class="px-4 sm:px-6 py-3 sm:py-4 bg-gradient-to-r from-purple-500 via-pink-500 to-indigo-500 text-white">
          <h2 class="text-lg sm:text-xl md:text-2xl font-bold flex items-center">
            <span class="mr-1 sm:mr-2">🔗</span>
            Real-Time AI Matches
          </h2>
        </div>
        <div class="p-3 sm:p-4 md:p-6">
          <div id="matches" class="space-y-4 sm:space-y-6">
            <!-- Loading state -->
            <div class="flex justify-center py-8 sm:py-12" id="loadingState">
              <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-b-2 border-purple-500"></div>
            </div>
            <!-- Empty state -->
            <div class="text-center py-8 sm:py-12 hidden" id="emptyState">
              <div class="text-4xl sm:text-6xl mb-2 sm:mb-4">🔍</div>
              <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-1 sm:mb-2">No matches found yet</h3>
              <p class="text-sm sm:text-base text-gray-500 px-2">AI matches will appear here as orders and offers are processed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
<script src="swipe.js"></script>
</body>
</html>
